<template>
  <div class="ddc-chart-container">
    <h2>{{ ndviData.crop }}</h2>
    <div id="ddc-chart"></div>
    <v-table style="width: 100%; border: 1px solid grey;" density="30">
      <tbody>
        <tr >
          <td><strong>Culture</strong></td>
          <td><strong>{{ ndviData.crop }}</strong></td>
        </tr>
        <tr style="background-color: #e8e8e8">
          <td>Surface</td>
          <td>{{ ndviData.areaHA_ta }} ha</td>
        </tr>
        <tr>
          <td>DDC moy culture SAU</td>
          <td>{{ ndviData.ddc_meanp_sau_ta }} jours</td>
        </tr>
        <tr style="background-color: #e8e8e8">
          <td>DDC moy culture PRA</td>
          <td>{{ ndviData.ddc_meanp_pra_ta }} jours</td>
        </tr>
      </tbody>
    </v-table>
  </div>
</template>

<script setup>
import ApexCharts from "apexcharts";
import { ref, onMounted, computed, watch } from "vue";

/**
 * Variables & hydratation
 */

const props = defineProps({
  data: Object,
  showLegend: Boolean,
});

// Object à envoyé en props
const ndviData = ref({
  crop: "Blé tendre d’hiver",
  areaHA_ta: 126,
  ddc_meanp_sau_ta: 245.0,
  ddc_meanp_pra_ta: 250.0,
  ndvi_smooth: [
    0.3974802974206201, 0.41130276545594047, 0.425193693774063,
    0.43911496392568616, 0.4530329137714456, 0.46691791621056106,
    0.480746061223116, 0.4945021667019755, 0.5081817544756105,
    0.5217821275416084, 0.5352993460393262, 0.5487255046433676,
    0.5620521486736608, 0.5752731368365679, 0.5883883757001321,
    0.6014116598034982, 0.6143709952984913, 0.6273037266668807,
    0.6402505899011459, 0.6532492505924213, 0.6663193237392463,
    0.6794647750917576, 0.6926688177583733, 0.7058918750758887,
    0.719069991573435, 0.732124939903284, 0.7449676777310158,
    0.7575018752866345, 0.7696289851226216, 0.781256270427318,
    0.7923008529027915, 0.8027008279752174, 0.8124209352241495,
    0.8214633633998321, 0.829858400335624, 0.8376551005074638,
    0.8449130750008107, 0.8516954098069291, 0.8580619278512387,
    0.8640626166635521, 0.869730801843304, 0.8750768363729412,
    0.8800818124222477, 0.8846921453349819, 0.8888254286548684,
    0.8923761737697007, 0.8952220466262388, 0.8972313769964804,
    0.8982713726161917, 0.8982073948442526, 0.8969033636892614,
    0.8942234517687059, 0.8900350483384155, 0.884212994188337,
    0.8766457750687286, 0.8672435737299051, 0.8559479571444608,
    0.8427436687177743, 0.8276725538939789, 0.8108151769643799,
    0.792279329680789, 0.7721860286316055, 0.7506534510875262,
    0.7277820882922856, 0.7036905902558451, 0.6785256015714424,
    0.6524590224120409, 0.625691104287193, 0.5984547281626404,
    0.5710206262255177, 0.543703072107555, 0.5168654188058165,
    0.4908960045082584, 0.46618183054371565, 0.44307544508436325,
    0.4218786844818743, 0.40283323965240125, 0.3860686711637909,
    0.37156260634457156, 0.3591639902208917, 0.34862652794650467,
    0.3396415197823566, 0.3318638485474322, 0.3249394964492636,
    0.31853562276012476, 0.31236616998114497, 0.3062105483491097,
    0.29992522451671066, 0.2934404126120509, 0.28676260152922745,
    0.279954661170378, 0.2731192416957419, 0.26638373597170173,
    0.2598856176187004, 0.2537536622336148, 0.24809139551067683,
    0.2429634394829218, 0.2384030547909333, 0.23441638863589542,
    0.2309879151612997, 0.2280871621207789, 0.2256730693583834,
    0.22369851455783687, 0.22211331233030018, 0.22086626877499646,
    0.21990739668316267, 0.21919011757765391, 0.21867172558634196,
    0.21831477971849114, 0.2180884872572358, 0.21796933570265292,
    0.21794157406853967, 0.21799408203483248, 0.218119647707721,
    0.2183149039987272, 0.21857946528085204, 0.21891591018414866,
    0.21932913231522572, 0.2198257121461212, 0.22041199768213895,
    0.22109313621804605, 0.22187340193744134, 0.22275580089100147,
    0.2237409268390244, 0.2248264677392555, 0.22600643729168754,
    0.22726990606577718, 0.22859988819247876, 0.22997176122882398,
    0.2313528028459569, 0.23270084672855057, 0.23396297375994604,
    0.23508338064076612, 0.23601198443041616, 0.23670959380658177,
    0.23715470547051307, 0.2373498148679243, 0.23732836273252667,
    0.23712143998256727, 0.2367570322516372, 0.2362594806575535,
    0.23564937313203638, 0.23494388427904542, 0.2341579854781339,
    0.23330530037354838, 0.23239755327746872, 0.23144488627757723,
    0.23045608621772803, 0.2294391912103993, 0.22840193328168545,
    0.22735222065161317, 0.22629885960670099, 0.2252506542131079,
    0.22421410968430025, 0.22319409521070038, 0.22219449512847061,
    0.2212185540324787, 0.2202692459409678, 0.2193496084658149,
    0.21846296215113656, 0.21761313293973594, 0.2168043687276141,
    0.21604152700024357, 0.2153302805666551, 0.214677327371994,
    0.2140906202576627, 0.21357898474053602, 0.2131515350336307,
    0.21281728027803742, 0.21258478664277922, 0.21246229392133884,
    0.2124577310299021, 0.21257813850280713, 0.21282979479533137,
    0.2132175101022368, 0.21374379743464506, 0.21440829017468732,
    0.2152072629114912, 0.2161330901259772, 0.21717243494078947,
    0.21830480738846536, 0.21950172309641494, 0.22072529470239516,
    0.22192778812208097, 0.22305053791888926, 0.22402231586571034,
    0.22475814319401088, 0.22517656881934403, 0.22521748351510604,
    0.2248437889943078, 0.22404659448481798, 0.22285150292338585,
    0.22132797064235774, 0.2195706899778979, 0.21768587529206526,
    0.21577542025729854, 0.21391988267154294, 0.21218235491219073,
    0.21060967947698933, 0.20923364651048282, 0.20807115647979343,
    0.20712562620735103, 0.206389664693797, 0.2058475353137751,
    0.20547675177859184, 0.20524934276069054, 0.2051332851817611,
    0.2050940141173908, 0.20509632468939767, 0.20510598134136784,
    0.20508988218887944, 0.2050163693657838, 0.20485578511908784,
    0.20458047782684333, 0.20416546841721134, 0.2035887906757374,
    0.20283141292350768, 0.20188151469791824, 0.2007350012713024,
    0.19939621069003086, 0.1978785674277745, 0.19620657831835853,
    0.1944180073412979, 0.19256620475317976, 0.19072275280429898,
    0.1889582925392436, 0.18732159224701983, 0.18584510192437834,
    0.18454988997683364, 0.18345046970758008, 0.1825581045291914,
    0.18188460738489137, 0.18144383311643825, 0.18125610196328074,
    0.1813482903364898, 0.1817562622959838, 0.18252818361114184,
    0.18372845128776272, 0.18543828414373656, 0.18776183504221758,
    0.19081501856250238, 0.19469058744863083, 0.1994804044261518,
    0.2052914416306742, 0.2122394807921504, 0.2204395621999274,
    0.2299975966645412, 0.24100036543415132, 0.25350060216173104,
    0.26756464013073056, 0.28325003702255147, 0.3005719358750433,
    0.3194974046876738, 0.3399374395277912, 0.36176100572773456,
    0.38480726451580616, 0.4088962661108611, 0.43388725346223195,
    0.4595781232578611, 0.48572353493637727, 0.512048162673748,
    0.5382606571068629, 0.5640705492766996, 0.589199780991314,
    0.6133993949506141, 0.6364680840729443, 0.6582493752163201,
    0.6786370604998749, 0.6975822326729614, 0.7150823515734118,
    0.7311703281356342, 0.7459019409471006, 0.7593482982426701,
    0.7715863979871735, 0.7826888648382818, 0.7927175037034347,
    0.8017240472798678, 0.8097524732438641, 0.8168382852040417,
    0.8230094342778815, 0.8282904332681921, 0.8327515855577607,
    0.8364941741025256, 0.8396402127964266, 0.8423218613620289,
    0.8446670743210841, 0.8467850843281639, 0.8487675883864474,
    0.85069016126646, 0.8526138044307616, 0.8545865548898108, 0.856645092987547,
    0.8588162539494333, 0.8611181179154407, 0.863561060202372,
    0.8661487008681591, 0.8688788060448467, 0.8717441631711127,
    0.8747334208868565, 0.8778317804672316, 0.8810209885285772,
    0.8842796170608478, 0.8875833413621345, 0.8909051485527145,
    0.8942155009933325, 0.8974819030306409, 0.9006690292358653,
    0.9037392722793941, 0.9066535272331037, 0.9093713113210715,
    0.9118517610891568, 0.914054427487494, 0.9159397182605038,
    0.9174692495698519, 0.9186079378448853, 0.9193255545583816,
    0.9195992828867122, 0.9194168161501239, 0.918779301262143,
    0.9177054369106777, 0.9162362053363914, 0.9144388833487586,
    0.9123921315694459, 0.910174731726939, 0.9078574134230752,
    0.9054935615302726, 0.9031103035000398, 0.9007133232190888,
    0.8982978942573279, 0.8958504691570637, 0.8933503371631332,
    0.890771260112426, 0.8880833571846006, 0.885255191665401,
    0.8822558396352707, 0.8790572565840125, 0.8756367229233367,
    0.8719793310348803, 0.8680806288687852, 0.8639496811997324,
    0.8596122029252318, 0.8551139592649315, 0.8505320532298795,
    0.8459851738666616, 0.8415631781455551, 0.8373516128762742,
    0.8334564116706463, 0.8299831465264393, 0.8270162630253828,
    0.8245909636134181, 0.8226671944794124, 0.8211024108680736,
    0.8196687452833626, 0.81807211671717, 0.8159707587415833,
    0.8129912272723074, 0.8087453130185916, 0.8028511321376786,
    0.7949494705659803, 0.7847276297726572, 0.771953711761549,
    0.7564766034342489, 0.7382233713300866, 0.7171973304032198,
    0.6934854389077202,
  ],
  dates_from_to: ["2022-10-01", "2023-09-30"],
});

const ndviDays = getDatesBetweenDates(
  new Date(ndviData.value.dates_from_to[0]),
  new Date(ndviData.value.dates_from_to[1])
);

// Options utilisée par Apexcharts
const options = ref({
  series: [
    {
      name: "ndvi",
      data: ndviData.value.ndvi_smooth,
    },
  ],
  chart: {
    width: 600,
    type: "line",
    zoom: {
      enabled: false,
    },
    animations: {
      enabled: false,
    },
    toolbar: {
      show: false,
    },
  },
  dataLabels: {
    enabled: false,
  },
  colors: ["black"],
  stroke: {
    curve: "smooth",
    width: 2,
  },

  xaxis: {
    categories: ndviDays,
    tickAmount: 10,
    tickPlacement: "on",
    labels: {
      style: {
        fontSize: "9px",
      },
    },
  },
  yaxis: {
    floating: false,
    tickAmount: 5,
    min: 0,
    max: 1,
    decimalsInFloat: 2,
  },
  grid: {
    row: {
      colors: ["#e5e5e5", "transparent"],
      opacity: 0.5,
    },
    column: {
      colors: ["#f8f8f8", "transparent"],
    },
    xaxis: {
      lines: {
        show: false,
      },
    },
  },
  annotations: {
    yaxis: [
      {
        y: 0.25,
        borderColor: "#00B050",
        label: {
          borderColor: "#00B050",
        },
      },
    ],
  },
});

const chart = ref(null);

/**
 * Cycle de vie du composant
 */

onMounted(() => {
  chart.value = new ApexCharts(
    document.getElementById("ddc-chart"),
    options.value
  );
  chart.value.render();
});

/**
 * Renvoie un tableau avec toutes les dates comprises entre deux dates
 */
function getDatesBetweenDates(startDate, endDate) {
  let dates = [];
  //to avoid modifying the original date
  const theDate = new Date(startDate);
  while (theDate < endDate) {
    dates = [...dates, new Date(theDate).toLocaleDateString("fr-FR")];
    theDate.setDate(theDate.getDate() + 1);
  }
  return dates;
}

</script>
<style scoped>
.ddc-chart-container {
  width: 600px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
</style>
